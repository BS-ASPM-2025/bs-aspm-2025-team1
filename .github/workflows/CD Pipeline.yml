name: Countinues Development Pipeline

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
jobs:

  test:
    name: run unit tests
    runs-on: ubuntu-latest
    steps:
      - name: step-1
        uses: actions/checkout@v4.0.0
      - name: step-2
        uses: "docker://python:3.14"
      - name: step-3
        run: ls -alr
      - name: install-req
        run: pip install -r requirements.txt
      - name: run-tests
        run: pytest -v tests/ --cov ./ --cov-report html:./rport-tests_${{ github.run_number }} --self-contained-html
      - name: upload-coverage-junit
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.run_number }}
          path: ./rport-tests_${{ github.run_number }}
      - name: upload-to-github-pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./rport-tests_${{ github.run_number }}

  deploy-pages:
    needs: test
    if: github.event_name == 'pull_request'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  lint:
    name: linter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: run-lint
        run: pylint --rcfile .pylintrc --output-format=parseable:art_pylint_${{ github.run_number }}.output.txt ./ || true
      - name: upload-lint-report
        uses: actions/upload-artifact@v4
        with:
          name: linter-report-${{ github.run_number }}
          path: art_pylint_${{ github.run_number }}.output.txt

  build:
    name: build docker image
    needs: [test, lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: login-docker
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: build-image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/aspm:team1-${{ github.actor }}-${{ github.run_number }} .
      - name: push-image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/aspm:team1-${{ github.actor }}-${{ github.run_number }}
  
  deploy:
    name: deploy-to-azure
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.base_ref == 'dev'
    steps:
      - uses: actions/checkout@v4
      - name: trigger-azure-pipeline
        run: |
          echo "Triggering Azure pipeline..."
          
          # Trigger the pipeline and capture the response
          response=$(curl -s -u :${{ secrets.AZURE_DEVOPS_TOKEN }} -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "resources": {
                "repositories": {
                  "self": {
                    "refName": "refs/heads/${{ github.head_ref }}"
                  }
                }
              },
              "templateParameters": {
                "imageTag": "${{ github.actor }}-${{ github.run_number }}"
              }
            }' \
            "https://dev.azure.com/${{ secrets.AZURE_ORG }}/${{ secrets.AZURE_PROJECT }}/_apis/pipelines/${{ secrets.AZURE_PIPELINE_ID }}/runs?api-version=6.0-preview.1")

          # Extract Run ID using grep/sed (avoiding jq dependency if not certain it's available, though usually is on ubuntu-latest)
          # Assuming standard Azure DevOps JSON response structure
          run_id=$(echo "$response" | jq -r '.id')
          
          if [ -z "$run_id" ] || [ "$run_id" == "null" ]; then
            echo "Failed to trigger pipeline. Response:"
            echo "$response"
            exit 1
          fi

          echo "Azure Pipeline Run ID: $run_id"
          echo "Pipeline URL: https://dev.azure.com/${{ secrets.AZURE_ORG }}/${{ secrets.AZURE_PROJECT }}/_build/results?buildId=$run_id"
          
          # Poll for status
          echo "Waiting for pipeline to complete..."
          status="inProgress"
          result=""
          
          while [ "$status" == "inProgress" ] || [ "$status" == "notStarted" ]; do
            sleep 10
            run_status_response=$(curl -s -u :${{ secrets.AZURE_DEVOPS_TOKEN }} \
              "https://dev.azure.com/${{ secrets.AZURE_ORG }}/${{ secrets.AZURE_PROJECT }}/_apis/pipelines/${{ secrets.AZURE_PIPELINE_ID }}/runs/$run_id?api-version=6.0-preview.1")
            
            status=$(echo "$run_status_response" | jq -r '.state')
            result=$(echo "$run_status_response" | jq -r '.result')
            
            echo "Current status: $status"
          done

          echo "Pipeline finished with status: $status and result: $result"

          if [ "$result" == "succeeded" ]; then
            echo "Deployment succeeded!"
            exit 0
          else
            echo "Deployment failed!"
            exit 1
          fi
