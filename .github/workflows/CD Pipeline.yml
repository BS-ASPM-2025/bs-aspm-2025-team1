name: Countinues Development Pipeline

on:
  push:
    branches:
      - "**"
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
jobs:
  test:
    name: run unit tests
    runs-on: ubuntu-latest
    steps:
      - name: step-1
        uses: actions/checkout@v4.0.0
      - name: step-2
        uses: "docker://python:3.14"
      - name: step-3
        run: ls -alr
      - name: install-req
        run: pip install -r requirements.txt
      - name: run-tests
        run: pytest -v tests/ --cov ./ --cov-report html:./rport-tests_${{ github.run_number }} --self-contained-html
      - name: upload-coverage-junit
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.run_number }}
          path: ./rport-tests_${{ github.run_number }}
      - name: upload-to-github-pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./rport-tests_${{ github.run_number }}

  deploy-pages:
    needs: test
    if: github.event_name == 'pull_request'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  lint:
    name: linter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: run-lint
        run: pylint --rcfile .pylintrc --output-format=parseable:art_pylint_${{ github.run_number }}.output.txt ./ || true
      - name: upload-lint-report
        uses: actions/upload-artifact@v4
        with:
          name: linter-report-${{ github.run_number }}
          path: art_pylint_${{ github.run_number }}.output.txt

  build:
    name: build docker image
    needs: [test, lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: login-docker
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: build-image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/aspm:team1-${{ github.actor }}-${{ github.run_number }} .
      - name: push-image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/aspm:team1-${{ github.actor }}-${{ github.run_number }}

  release:
    name: create release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.action == 'opened'||github.event.action == 'synchronize') && github.base_ref == 'dev'

    outputs:
      version: ${{ steps.extract_version.outputs.VERSION }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Extract Version
        id: extract_version
        uses: actions/github-script@v7
        with:
          script: |
            let msg = '';
            // For Pull Requests, looking at the Title is standard and easier to control
            if (context.eventName === 'pull_request') {
              msg = context.payload.pull_request.title;
              console.log('Checking PR Title: ' + msg);
            } else {
              // For Push events, check the commit message
              msg = context.payload.head_commit.message;
              console.log('Checking Commit Message: ' + msg);
            }

            // Extract "release vX.Y.Z"
            const match = msg.match(/release\s+(v?\d+\.\d+\.\d+)/);
            if (match && match[1]) {
              console.log('Found Version: ' + match[1]);
              core.setOutput('VERSION', match[1]);
            } else {
              console.log('No version found in message');
              // Optional: Fail if strict, or just leave empty to skip
              // core.setFailed('No release tag found in commit message or PR title');
            }
      - name: Pull Docker Image
        run: docker pull ${{ secrets.DOCKER_USERNAME }}/aspm:team1-${{ github.actor }}-${{ github.run_number }}
      - name: Tag Release Image
        if: steps.extract_version.outputs.VERSION != ''
        run: docker tag ${{ secrets.DOCKER_USERNAME }}/aspm:team1-${{ github.actor }}-${{ github.run_number }} ${{ secrets.DOCKER_USERNAME }}/aspm:${{ steps.extract_version.outputs.VERSION }}
      - name: Push Release Image
        if: steps.extract_version.outputs.VERSION != ''
        run: docker push ${{ secrets.DOCKER_USERNAME }}/aspm:${{ steps.extract_version.outputs.VERSION }}

      - name: Create GitHub Release
        if: steps.extract_version.outputs.VERSION != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract_version.outputs.VERSION }}
          name: Release ${{ steps.extract_version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true

  deploy:
    name: deploy-to-azure
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always() && needs.build.result == 'success' && (needs.release.result == 'success' || needs.release.result == 'skipped') && (github.event_name == 'pull_request' || github.ref == 'refs/heads/BSASPM25T1-48')
    environment:
      name: Development
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: "projectmanagement"
          images: "${{ secrets.DOCKER_USERNAME }}/aspm:${{ needs.release.outputs.version != '' && needs.release.outputs.version || format('team1-{0}-{1}', github.actor, github.run_number) }}"
