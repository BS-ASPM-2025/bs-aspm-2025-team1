name: release.yml
on:
  pull_request:
    types: [closed]
    branches: ["dev"]
  workflow_dispatch:
jobs:

  build:
    name: build docker image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: login-docker
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Sanitize Actor
        id: actor_sanitize
        run: |
          SANITIZED_ACTOR=$(echo "${{ github.actor }}" | tr -d '[]')
          echo "sanitized_actor=$SANITIZED_ACTOR" >> "$GITHUB_OUTPUT"
      - name: build-image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/aspm:team1-${{ steps.actor_sanitize.outputs.sanitized_actor }}-${{ github.run_number }} .
      - name: push-image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/aspm:team1-${{ steps.actor_sanitize.outputs.sanitized_actor }}-${{ github.run_number }}

  release:
    name: create release
    runs-on: ubuntu-latest
    if: |
          github.event.pull_request.merged == true &&
          contains(github.event.pull_request.title, 'release')
    outputs:
      version: ${{ steps.extract_version.outputs.VERSION }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract Version
        id: extract_version
        uses: actions/github-script@v7
        with:
          script: |
            const msg = context.payload.pull_request.title || '';
            console.log('Commit message:', msg);
            const match = msg.match(/release\s+(v\d+\.\d+\.\d+)/);
            if (!match) {
              core.setFailed('No release version found in commit message');
              return;
            }
            core.setOutput('VERSION', match[1]);
      - name: Sanitize Actor
        id: actor_sanitize
        run: |
          SANITIZED_ACTOR=$(echo "${{ github.actor }}" | tr -d '[]')
          echo "sanitized_actor=$SANITIZED_ACTOR" >> "$GITHUB_OUTPUT"

      - name: Check if tag already exists
        run: |
          git fetch --tags
          if git rev-parse "${{ steps.extract_version.outputs.VERSION }}" >/dev/null 2>&1; then
            echo "‚ùå Tag already exists: ${{ steps.extract_version.outputs.VERSION }}"
            exit 1
          fi

      - name: Pull Docker Image
        run: docker pull ${{ secrets.DOCKER_USERNAME }}/aspm:team1-${{ steps.actor_sanitize.outputs.sanitized_actor }}-${{ github.run_number }}
      - name: Tag Release Image
        if: steps.extract_version.outputs.VERSION != ''
        run: docker tag ${{ secrets.DOCKER_USERNAME }}/aspm:team1-${{ steps.actor_sanitize.outputs.sanitized_actor }}-${{ github.run_number }} ${{ secrets.DOCKER_USERNAME }}/aspm:${{ steps.extract_version.outputs.VERSION }}
      - name: Push Release Image
        if: steps.extract_version.outputs.VERSION != ''
        run: docker push ${{ secrets.DOCKER_USERNAME }}/aspm:${{ steps.extract_version.outputs.VERSION }}

      - name: Create GitHub Release
        if: steps.extract_version.outputs.VERSION != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract_version.outputs.VERSION }}
          name: Release ${{ steps.extract_version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
